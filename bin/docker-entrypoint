#!/usr/bin/env bash
set -euo pipefail

echo "==> Bootstrapping Rails in ${RAILS_ENV:-?}"

# Sanity: credentials y secret
if [ -z "${RAILS_MASTER_KEY:-}" ]; then
  echo "FATAL: RAILS_MASTER_KEY missing"; exit 1
fi
if [ -z "${SECRET_KEY_BASE:-}" ]; then
  echo "WARN: SECRET_KEY_BASE missing (set it for safety/performance)"
fi

# DB wait
if [ -z "${DATABASE_URL:-}" ]; then
  echo "WARN: No DATABASE_URL set, skipping database preparation"
else
  echo "==> Waiting for database..."
  max=30; i=1
  until bundle exec rails db:version >/dev/null 2>&1; do
    if [ $i -gt $max ]; then
      echo "FATAL: Database connection timeout after $max attempts"; exit 1
    fi
    echo "Attempt $i/$max - Database not ready, waiting..."
    i=$((i+1)); sleep 2
  done

  echo "==> Running db:prepare"
  bundle exec rails db:prepare
fi

echo "==> Starting Puma on ${PORT:-8080}"
exec "$@"
